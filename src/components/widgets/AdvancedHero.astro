---
import Image from '~/components/common/Image.astro';
import Button from '~/components/ui/Button.astro';
import ScrollingTags from '~/components/widgets/ScrollingTags.astro';

import type { Hero as Props } from '~/types';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline,

  content = await Astro.slots.render('content'),
  actions = await Astro.slots.render('actions'),
  image = await Astro.slots.render('image'),

  id,
  bg = await Astro.slots.render('bg'),

  // Advanced options
  enableAnimatedBackground = true,
  enableScrollingTags = true,
  tags = [],
} = Astro.props;
---

<section
  class="relative min-h-screen overflow-hidden bg-blue-50 dark:bg-slate-900 md:-mt-[76px]"
  {...id ? { id } : {}}
>
  <!-- Grid Pattern Background -->
  <div
    class="absolute inset-0 bg-[linear-gradient(to_right,#e5e7eb_1px,transparent_1px),linear-gradient(to_bottom,#e5e7eb_1px,transparent_1px)] dark:bg-[linear-gradient(to_right,#0f172a_1px,transparent_1px),linear-gradient(to_bottom,#0f172a_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_110%)] opacity-40 dark:opacity-40"
  >
  </div>

  <!-- Scrolling Tags -->
  {enableScrollingTags && tags && tags.length > 0 && (
    <ScrollingTags uniqueTags={tags.map(tag => typeof tag === 'string' ? tag : tag.text)} />
  )}

  <!-- Animated Gradient Orbs -->
  {enableAnimatedBackground && (
    <div class="absolute inset-0 pointer-events-none overflow-hidden z-5">
      <div class="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-emerald-500/30 dark:bg-emerald-500/40 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-1/4 right-1/4 w-[500px] h-[500px] bg-blue-500/30 dark:bg-blue-500/40 rounded-full blur-3xl animate-pulse delay-1000"></div>
      <div class="absolute top-1/2 right-1/3 w-[400px] h-[400px] bg-purple-500/25 dark:bg-purple-500/35 rounded-full blur-3xl animate-pulse delay-2000"></div>
    </div>
  )}

  <!-- Hero Content -->
  <div class="relative mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 min-h-screen flex items-center justify-center pointer-events-none z-10">
    <div class="text-center w-full py-20">
      <div class="relative flex flex-col justify-center items-center pointer-events-auto z-10 max-w-3xl mx-auto" id="mona-text">
        <div id="hero-content">
          {
            title && (
              <h1 class="mb-5 text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl md:text-6xl">
                <Fragment set:html={title} />
              </h1>
            )
          }

          {
            subtitle && (
              <p class="mx-auto max-w-2xl text-base text-gray-700 dark:text-white/90 leading-relaxed mb-4 sm:text-lg">
                <Fragment set:html={subtitle} />
              </p>
            )
          }
        </div>

        {
          actions && (
            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center opacity-0 translate-y-2 pointer-events-none transform" data-hero-button>
              {Array.isArray(actions) ? (
                actions.map((action) => (
                  <Button {...(action || {})} class="pointer-events-auto" />
                ))
              ) : (
                <Fragment set:html={actions} />
              )}
            </div>
          )
        }
      </div>
    </div>
  </div>
</section>

<script>
  import { createTimeline, stagger, text } from "animejs";

  document.addEventListener("DOMContentLoaded", () => {
    const heroContent = document.getElementById("hero-content");
    const title = heroContent?.querySelector("h1");
    const subtitle = heroContent?.querySelector("p");
    const heroButton = document.querySelector("[data-hero-button]") as
      | HTMLElement
      | null;

    const startTags = () => {
      document.dispatchEvent(new Event("start-tags"));
    };

    const revealButton = () => {
      if (!heroButton) {
        startTags();
        return;
      }

      const buttonTimeline = createTimeline({});
      buttonTimeline.add(heroButton, {});
      buttonTimeline.init().then(() => {
        heroButton.classList.remove(
          "opacity-0",
          "translate-y-2",
          "pointer-events-none"
        );
        heroButton.classList.add("pointer-events-auto");
        startTags();
      });
    };

    if (title || subtitle) {
      const allChars: HTMLElement[] = [];

      // Split title
      if (title) {
        const { chars: titleChars } = text.split(title, {
          words: false,
          chars: true,
        });
        allChars.push(...titleChars);
      }

      // Split subtitle
      if (subtitle) {
        const { chars: subtitleChars } = text.split(subtitle, {
          words: false,
          chars: true,
        });
        allChars.push(...subtitleChars);
      }

      const headlineTimeline = createTimeline({
        loop: false,
        defaults: { ease: "inOut(3)", duration: 1500 },
      });

      headlineTimeline
        .add(
          allChars,
          {
            y: [($el) => (+$el.dataset.line % 2 ? "100%" : "-200%"), "0%"],
            opacity: [0, 1],
          },
          stagger(10, { from: "random" })
        )
        .init()
        .then(revealButton);
    } else {
      revealButton();
    }
  });
</script>

<style>
  /* Animation delays */
  .delay-1000 {
    animation-delay: 1s;
  }

  .delay-2000 {
    animation-delay: 2s;
  }

  /* Text glow effect */
  .text-glow {
    text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
  }

  /* Z-index layers */
  .z-5 {
    z-index: 5;
  }

  /* Hide horizontal rules in hero content */
  #hero-content hr {
    display: none !important;
  }

  /* Fix for animated characters - override transparent text fill */
  #hero-content h1 .char,
  #hero-content h1 > span,
  #hero-content h1 span span {
    -webkit-text-fill-color: currentColor !important;
    background: none !important;
    -webkit-background-clip: unset !important;
    background-clip: unset !important;
    display: inline-block;
  }

  /* Ensure all text is visible during animation */
  #hero-content h1 {
    -webkit-text-fill-color: currentColor !important;
    background: none !important;
  }
</style>